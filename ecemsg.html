<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <link rel="shortcut icon" type="image/x-icon" href="/images/logo/ume.ink.fav.ico" />
    <link rel="stylesheet" href="main.css" />
    <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
    <style>
      body {
        background-color: #f0f0f0;
        padding-top: 30px;
      }
      #textWrapper {
        width: calc(100% - 20px);
        max-width: 800px;
        margin: 20px auto;
        padding: 0 10px;
        text-align: left;
      }
      #textWrapper textarea {
        width: calc(100% - 44px);
        max-width: 756px;
        height: 300px;
        padding: 20px;
        border: 2px solid #f24632;
        background-color: #fff;
        resize: none;
        font-size: 16px;
      }
      #textWrapper textarea:focus {
        outline-color: #f24632;
      }
      #textWrapper .info {
        padding: 7px 1px;
        font-size: 8px;
        color: #666;
      }
      .hidden {
        display: none;
      }
      #cpBt:after {
        padding-left: 5px;
        font-size: 10px;
        color: #f24632;
        content: attr(data-value);
      }
    </style>

    <title> Encrypt a message - UME.INK </title>
  </head>

  <body>
    <div class="leftAlign leftMargin">
      <a href="index.html">< Back</a>
    </div>
    <div id="textWrapper">
      <h5 id="notify">type a message:</h5>
      <textarea id="msgbox" autofocus></textarea>
      <button id='encBt' onclick="encrypt()">encrypt it with my PGP public key</button>
      <button id='editBt' class="hidden" onclick="edit()">back to edit mode</button>
      <a id='sendm' class="hidden buttonStyle" href="" target="_blank">mail to me</a>
      <span id='cpBt' class="hidden"><button onclick="copy()">COPY</button></span>
      <div class="info">Powered by OpenPGP.js, works well with recent versions of Chrome, Firefox, Safari and Edge</div>
    </div>
    <script src="/openpgp.min.js" integrity="sha384-TS0uWY7lSW2o43PKPc6ICKryJRZV2gtYvuV/U/h0hKkCC/DIDxOHRIo6w/tH+ql7"></script>
    <script>
      const pubkey =
        ['-----BEGIN PGP PUBLIC KEY BLOCK-----',
         '',
         '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',
         '2/YCXJn4zDp9kEsI',
         '=ylCo',
         '-----END PGP PUBLIC KEY BLOCK-----'].join('\n');
        var msg = '';
        const notif  = document.getElementById('notify');
        const encBt  = document.getElementById('encBt');
        const sendBt = document.getElementById('sendm');
        const cpBtS  = document.getElementById('cpBt');
        const editBt = document.getElementById('editBt');
        const msgB   = document.getElementById('msgbox');

        const encryptFunction = async(m) => {
          const publicKey = await openpgp.readKey({ armoredKey: pubkey });
          const encrypted = await openpgp.encrypt({
              message: await openpgp.createMessage({ text: m }),
              encryptionKeys: publicKey
          });
          return encrypted;
        }
        var encrypt = async() => {
          msg = msgB.value;
          encBt.innerHTML = 'encrypt it with my PGP public key (encrypting..)';
          cipher = (await encryptFunction(msg));
          msgB.value = cipher;
          notif.innerHTML = 'the encrypted message:';
          sendBt.href='mailto:i@bitbili.net?subject='
            + encodeURIComponent('A message from UME.INK')
            + '&body='
            + encodeURIComponent(cipher);
          msgB.disabled = true;
          msgB.style.backgroundColor = '#f3f3f3';
          encBt.style.display = 'none';
          sendBt.style.display = 'inline-block';
          editBt.style.display = 'inline-block';
          cpBtS.style.display = 'inline-block';
          window.getSelection().removeAllRanges();
          cpBtS.setAttribute('data-value', '');
        }
        function copy() {
          cpBtS.setAttribute('data-value', '');
          if (/iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream) {
            var range = document.createRange();
            msgB.disabled=false;
            range.selectNodeContents(msgB);
            var s = window.getSelection();
            s.removeAllRanges();
            s.addRange(range);
            msgB.setSelectionRange(0, 999999);
            msgB.disabled=true;
          } else {
            msgB.disabled=false;
            msgB.select();
            msgB.disabled=true;
          }
          copied = window.getSelection().rangeCount > 0 && document.execCommand("copy");
          cpBtS.setAttribute('data-value', copied ? 'copied!' : 'uncopied!');
        }
        function edit() {
          msgB.value = msg;
          notif.innerHTML = 'type a message:';
          msgB.disabled = false;
          msgB.focus();
          msgB.style.backgroundColor = '#fff';
          encBt.innerHTML = 'encrypt it with my PGP public key';
          sendBt.href = '';
          encBt.style.display = 'inline-block';
          sendBt.style.display = 'none';
          editBt.style.display = 'none';
          cpBtS.style.display = 'none';
        }
    </script>
  </body>
</html>
